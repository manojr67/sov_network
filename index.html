<script>
    const CipherShield = {
        MESH_SECRET: "SOV_LATTICE_INTEGRITY_SHIELD_99",
        encryptData(payload) {
            return CryptoJS.AES.encrypt(JSON.stringify(payload), this.MESH_SECRET).toString();
        },
        decryptData(cipherText) {
            try {
                const bytes = CryptoJS.AES.decrypt(cipherText, this.MESH_SECRET);
                return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
            } catch (e) { return null; }
        }
    };

    let currentInput = "";
    let attempts = 0;
    const PIN_HASH = "a665a45920422f9d417e4867efdc4fb8a04a1f3fff1fa07e998e86f7f7a27ae3";

    const gun = Gun({
        peers: ['https://gun-manhattan.herokuapp.com/gun', 'https://sov-relay.onrender.com/gun']
    });

    function switchTab(tabId) {
        document.querySelectorAll('.page-section').forEach(sec => sec.classList.remove('active'));
        document.getElementById('section-' + tabId).classList.add('active');
        if(tabId === 'home') setTimeout(initMap, 200);
    }

    function handleInput(n) {
        if (localStorage.getItem('sov_lockout') > Date.now()) return;
        currentInput += n;
        document.getElementById('pin-view').innerText = "*".repeat(currentInput.length);
        
        if(currentInput.length === 3) {
            const inputHash = CryptoJS.SHA256(currentInput).toString();
            if(inputHash === PIN_HASH) {
                successRedirect("HANDSHAKE VERIFIED");
            } else {
                attempts++;
                currentInput = ""; 
                document.getElementById('pin-view').innerText = "***";
                const status = document.getElementById('v-status');
                
                if(attempts >= 10) {
                    executeSelfDestruct();
                    return;
                }

                status.innerText = `INVALID HANDSHAKE: ${3 - (attempts % 3)} REMAINING`;
                status.style.color = "var(--danger)";
                
                if(attempts % 3 === 0) triggerLockout();
            }
        }
    }

    function executeSelfDestruct() {
        localStorage.clear();
        sessionStorage.clear();
        document.body.innerHTML = `
            <div style="height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; background:#020617; color:#ef4444; text-align:center; font-family:sans-serif;">
                <i class="bi bi-exclamation-triangle" style="font-size:4rem;"></i>
                <h1 style="margin-top:20px;">NODE SELF-DESTRUCTED</h1>
                <p style="color:#94a3b8; max-width:400px;">Identity Shards purged from local storage due to high-risk intrusion attempt. Handshake permanently voided.</p>
                <button onclick="location.reload()" style="margin-top:30px; padding:10px 30px; border-radius:50px; border:none; background:#ef4444; color:white; font-weight:800; cursor:pointer;">RE-INITIALIZE FROM SCRATCH</button>
            </div>
        `;
        console.warn("CRITICAL: SENSITIVE DATA PURGED.");
    }

    function triggerLockout() {
        const lockTime = Date.now() + (5 * 60 * 1000);
        localStorage.setItem('sov_lockout', lockTime);
        checkLockout();
    }

    function checkLockout() {
        const lockTime = localStorage.getItem('sov_lockout');
        const overlay = document.getElementById('lockout-timer');
        if (lockTime > Date.now()) {
            overlay.classList.remove('hidden');
            const timer = setInterval(() => {
                const remaining = Math.ceil((lockTime - Date.now()) / 1000);
                document.getElementById('timer-val').innerText = `LOCKED FOR ${remaining}s`;
                if(remaining <= 0) {
                    clearInterval(timer);
                    overlay.classList.add('hidden');
                }
            }, 1000);
        }
    }

    function successRedirect(msg) {
        const sessionKey = CryptoJS.lib.WordArray.random(32).toString();
        sessionStorage.setItem('sov_auth_session', sessionKey); 
        const secureShard = CipherShield.encryptData({
            sender: "MASTER_ID", action: "HANDSHAKE_VERIFIED", timestamp: Date.now()
        });
        gun.get('sov_global_ledger').set(secureShard);
        localStorage.setItem('sov_id_created', 'true');
        document.getElementById('v-status').innerText = msg;
        document.getElementById('v-status').style.color = "var(--success)";
        setTimeout(() => { window.location.href = "citadel.html"; }, 1000);
    }

    function renderPad() {
        const pad = document.getElementById('pin-pad');
        if(!pad) return;
        pad.innerHTML = "";
        [1,2,3,4,5,6,7,8,9,0].sort(() => Math.random() - 0.5).forEach(n => {
            const btn = document.createElement('button');
            btn.className = 'pad-btn'; btn.innerText = n;
            btn.onclick = () => handleInput(n);
            pad.appendChild(btn);
        });
    }

    function initMap() {
        const container = document.getElementById('node-map');
        if (container._leaflet_id) return;
        const map = L.map('node-map', { zoomControl: false }).setView([20, 0], 2);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        const nodes = [[51.5, -0.09], [40.7, -74], [35.6, 139.6], [28.6, 77.2], [-33.8, 151.2], [19.07, 72.87]];
        nodes.forEach(pos => {
            L.circleMarker(pos, { color: '#f7931a', radius: 5, fillOpacity: 0.8 }).addTo(map)
                .bindPopup("Sovereign Mesh Node: ACTIVE");
        });
    }

    window.onload = () => { renderPad(); initMap(); checkLockout(); };
</script>